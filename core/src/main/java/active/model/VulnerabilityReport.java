package active.model;

import model.Severity;

import java.time.Instant;
import java.util.*;

/**
 * Detailed report of a discovered vulnerability during active testing.
 */
public final class VulnerabilityReport {
    private final String id;
    private final VulnerabilityType type;
    private final Severity severity;
    private final ApiEndpoint endpoint;
    private final String title;
    private final String description;
    private final String reproductionSteps;
    private final TestRequest exploitRequest;
    private final TestResponse exploitResponse;
    private final Map<String, Object> evidence;
    private final List<String> recommendations;
    private final Instant discoveredAt;

    public enum VulnerabilityType {
        BOLA("Broken Object Level Authorization", "API1:2023"),
        BROKEN_AUTHENTICATION("Broken Authentication", "API2:2023"),
        BOPLA("Broken Object Property Level Authorization", "API3:2023"),
        UNRESTRICTED_RESOURCE("Unrestricted Resource Consumption", "API4:2023"),
        BFLA("Broken Function Level Authorization", "API5:2023"),
        UNRESTRICTED_BUSINESS_FLOW("Unrestricted Access to Sensitive Business Flows", "API6:2023"),
        SSRF("Server Side Request Forgery", "API7:2023"),
        SECURITY_MISCONFIGURATION("Security Misconfiguration", "API8:2023"),
        IMPROPER_INVENTORY("Improper Inventory Management", "API9:2023"),
        UNSAFE_API_CONSUMPTION("Unsafe Consumption of APIs", "API10:2023"),
        SQL_INJECTION("SQL Injection", "INJECTION"),
        COMMAND_INJECTION("Command Injection", "INJECTION"),
        PATH_TRAVERSAL("Path Traversal", "INJECTION"),
        XXE("XML External Entity (XXE)", "INJECTION"),
        UNSAFE_DESERIALIZATION("Unsafe Deserialization", "INJECTION"),
        MASS_ASSIGNMENT("Mass Assignment", "OTHER"),
        INFORMATION_DISCLOSURE("Information Disclosure", "OTHER"),
        WEAK_CRYPTOGRAPHY("Weak Cryptography", "OTHER"),
        MISSING_RATE_LIMITING("Missing Rate Limiting", "OTHER"),
        EXCESSIVE_DATA_EXPOSURE("Excessive Data Exposure", "OTHER"),
        CACHE_POISONING("Cache Poisoning", "OTHER");

        private final String displayName;
        private final String category;

        VulnerabilityType(String displayName, String category) {
            this.displayName = displayName;
            this.category = category;
        }

        public String getDisplayName() {
            return displayName;
        }

        public String getCategory() {
            return category;
        }
    }

    private VulnerabilityReport(Builder builder) {
        this.id = UUID.randomUUID().toString();
        this.type = Objects.requireNonNull(builder.type, "type cannot be null");
        this.severity = Objects.requireNonNull(builder.severity, "severity cannot be null");
        this.endpoint = Objects.requireNonNull(builder.endpoint, "endpoint cannot be null");
        this.title = builder.title != null ? builder.title : type.getDisplayName();
        this.description = builder.description;
        this.reproductionSteps = builder.reproductionSteps;
        this.exploitRequest = builder.exploitRequest;
        this.exploitResponse = builder.exploitResponse;
        this.evidence = builder.evidence != null
            ? Collections.unmodifiableMap(new LinkedHashMap<>(builder.evidence))
            : Collections.emptyMap();
        this.recommendations = builder.recommendations != null
            ? Collections.unmodifiableList(new ArrayList<>(builder.recommendations))
            : Collections.emptyList();
        this.discoveredAt = builder.discoveredAt != null ? builder.discoveredAt : Instant.now();
    }

    public static Builder builder() {
        return new Builder();
    }

    public String getId() {
        return id;
    }

    public VulnerabilityType getType() {
        return type;
    }

    public Severity getSeverity() {
        return severity;
    }

    public ApiEndpoint getEndpoint() {
        return endpoint;
    }

    public String getTitle() {
        return title;
    }

    public String getDescription() {
        return description;
    }

    public String getReproductionSteps() {
        return reproductionSteps;
    }

    public TestRequest getExploitRequest() {
        return exploitRequest;
    }

    public TestResponse getExploitResponse() {
        return exploitResponse;
    }

    public Map<String, Object> getEvidence() {
        return evidence;
    }

    public List<String> getRecommendations() {
        return recommendations;
    }

    public Instant getDiscoveredAt() {
        return discoveredAt;
    }

    @Override
    public String toString() {
        return "VulnerabilityReport{" +
               "id='" + id + '\'' +
               ", type=" + type +
               ", severity=" + severity +
               ", endpoint=" + endpoint +
               '}';
    }

    public static class Builder {
        private VulnerabilityType type;
        private Severity severity;
        private ApiEndpoint endpoint;
        private String title;
        private String description;
        private String reproductionSteps;
        private TestRequest exploitRequest;
        private TestResponse exploitResponse;
        private Map<String, Object> evidence;
        private List<String> recommendations;
        private Instant discoveredAt;

        public Builder type(VulnerabilityType type) {
            this.type = type;
            return this;
        }

        public Builder severity(Severity severity) {
            this.severity = severity;
            return this;
        }

        public Builder endpoint(ApiEndpoint endpoint) {
            this.endpoint = endpoint;
            return this;
        }

        public Builder title(String title) {
            this.title = title;
            return this;
        }

        public Builder description(String description) {
            this.description = description;
            return this;
        }

        public Builder reproductionSteps(String reproductionSteps) {
            this.reproductionSteps = reproductionSteps;
            return this;
        }

        public Builder exploitRequest(TestRequest exploitRequest) {
            this.exploitRequest = exploitRequest;
            return this;
        }

        public Builder exploitResponse(TestResponse exploitResponse) {
            this.exploitResponse = exploitResponse;
            return this;
        }

        public Builder evidence(Map<String, Object> evidence) {
            this.evidence = evidence;
            return this;
        }

        public Builder addEvidence(String key, Object value) {
            if (this.evidence == null) {
                this.evidence = new LinkedHashMap<>();
            }
            this.evidence.put(key, value);
            return this;
        }

        public Builder recommendations(List<String> recommendations) {
            this.recommendations = recommendations;
            return this;
        }

        public Builder addRecommendation(String recommendation) {
            if (this.recommendations == null) {
                this.recommendations = new ArrayList<>();
            }
            this.recommendations.add(recommendation);
            return this;
        }

        public Builder discoveredAt(Instant discoveredAt) {
            this.discoveredAt = discoveredAt;
            return this;
        }

        public VulnerabilityReport build() {
            return new VulnerabilityReport(this);
        }
    }
}
