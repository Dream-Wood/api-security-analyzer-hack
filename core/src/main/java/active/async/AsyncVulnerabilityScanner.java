package active.async;

import active.protocol.ProtocolClient;
import active.scanner.ScanContext;
import model.AsyncOperationSpec;

import java.util.Collections;
import java.util.List;

/**
 * Interface for async vulnerability scanners that test AsyncAPI operations.
 * Similar to VulnerabilityScanner but designed for async protocols (Kafka, MQTT, WebSocket, etc.).
 *
 * <p>Scanners are loaded as hotswap plugins using Java ServiceLoader mechanism.
 * Each scanner focuses on a specific vulnerability category (e.g., unauthorized access,
 * message injection, replay attacks).
 *
 * <p><b>Plugin Discovery:</b>
 * <ol>
 *   <li>Create implementation of this interface</li>
 *   <li>Add META-INF/services/active.async.AsyncVulnerabilityScanner file</li>
 *   <li>List your implementation class in the service file</li>
 *   <li>Package as JAR and place in plugins/ directory</li>
 * </ol>
 *
 * <p><b>Thread Safety:</b> Implementations must be thread-safe as they may be called
 * concurrently for different operations.
 *
 * <p><b>Example Implementation:</b>
 * <pre>
 * public class UnauthorizedSubscriptionScanner implements AsyncVulnerabilityScanner {
 *     public String getName() { return "Unauthorized Subscription"; }
 *     public AsyncScanResult scan(AsyncOperationSpec operation, ProtocolClient client, ScanContext context) {
 *         // Test if subscription is possible without authentication
 *     }
 * }
 * </pre>
 */
public interface AsyncVulnerabilityScanner {

    /**
     * Get the scanner name (used for reporting and logging).
     *
     * @return scanner name
     */
    String getName();

    /**
     * Get the scanner description.
     *
     * @return scanner description
     */
    String getDescription();

    /**
     * Get the list of protocols supported by this scanner.
     * Return empty list or ["*"] to indicate support for all protocols.
     *
     * <p>Examples:
     * <ul>
     *   <li>["kafka"] - only Kafka</li>
     *   <li>["mqtt", "mqtts"] - MQTT and MQTT over TLS</li>
     *   <li>["ws", "wss"] - WebSocket and WebSocket Secure</li>
     *   <li>["*"] or [] - all protocols</li>
     * </ul>
     *
     * @return list of supported protocol names (lowercase)
     */
    default List<String> getSupportedProtocols() {
        return Collections.emptyList(); // Empty = all protocols
    }

    /**
     * Check if this scanner is applicable to the given operation.
     *
     * <p>Scanners can filter operations based on:
     * <ul>
     *   <li>Operation type (PUBLISH vs SUBSCRIBE)</li>
     *   <li>Channel name patterns</li>
     *   <li>Security requirements</li>
     *   <li>Message schemas</li>
     * </ul>
     *
     * @param operation the async operation to check
     * @return true if this scanner should run for this operation
     */
    boolean isApplicable(AsyncOperationSpec operation);

    /**
     * Scan an AsyncAPI operation for vulnerabilities.
     *
     * <p>The scanner should:
     * <ol>
     *   <li>Use the ProtocolClient to interact with the async system</li>
     *   <li>Test for specific vulnerability patterns</li>
     *   <li>Create VulnerabilityReport for any findings</li>
     *   <li>Return AsyncScanResult with results</li>
     * </ol>
     *
     * <p><b>Important:</b>
     * <ul>
     *   <li>Respect scan intensity settings from context</li>
     *   <li>Handle protocol errors gracefully</li>
     *   <li>Include evidence in vulnerability reports</li>
     *   <li>Use meaningful descriptions for findings</li>
     * </ul>
     *
     * @param operation the async operation to scan
     * @param client    the protocol client for communication
     * @param context   scan context with settings and shared data
     * @return scan result with findings
     */
    AsyncScanResult scan(AsyncOperationSpec operation, ProtocolClient client, ScanContext context);

    /**
     * Get the scanner version.
     * Used for tracking and compatibility purposes.
     *
     * @return scanner version (default: "1.0.0")
     */
    default String getVersion() {
        return "1.0.0";
    }

    /**
     * Check if this scanner is enabled by default.
     * Can be overridden in configuration.
     *
     * @return true if enabled by default (default: true)
     */
    default boolean isEnabledByDefault() {
        return true;
    }

    /**
     * Get the scanner author/organization.
     * Used for attribution and support.
     *
     * @return author name (default: "Unknown")
     */
    default String getAuthor() {
        return "Unknown";
    }
}
