package active.async;

import active.protocol.ProtocolMessage;
import model.AsyncOperationSpec;
import model.Severity;

import java.time.Instant;
import java.util.*;

/**
 * Detailed report about a vulnerability found during AsyncAPI active testing.
 * Extends the concept of VulnerabilityReport to async protocols with protocol-specific metadata.
 *
 * <p>Contains information about:
 * <ul>
 *   <li>Vulnerability type and severity</li>
 *   <li>Affected async operation (channel + operation type)</li>
 *   <li>Protocol-specific metadata (broker info, message details)</li>
 *   <li>Proof-of-concept messages</li>
 *   <li>Evidence and recommendations</li>
 * </ul>
 */
public final class AsyncVulnerabilityReport {

    private final String id;
    private final AsyncVulnerabilityType type;
    private final Severity severity;
    private final AsyncOperationSpec operation;
    private final ProtocolMetadata protocolMetadata;
    private final String title;
    private final String description;
    private final String reproductionSteps;
    private final ProtocolMessage exploitMessage;
    private final ProtocolMessage responseMessage;
    private final Map<String, Object> evidence;
    private final List<String> recommendations;
    private final Instant discoveredAt;

    /**
     * Vulnerability types specific to AsyncAPI and event-driven architectures.
     */
    public enum AsyncVulnerabilityType {
        UNAUTHORIZED_SUBSCRIPTION("Unauthorized Subscription", "ASYNC_AUTH",
                "Ability to subscribe to channels without proper authentication"),
        UNAUTHORIZED_PUBLISH("Unauthorized Publish", "ASYNC_AUTH",
                "Ability to publish messages without proper authentication"),
        MESSAGE_INJECTION("Message Injection", "ASYNC_INJECTION",
                "Injection of malicious content in message payloads"),
        TOPIC_ENUMERATION("Topic/Channel Enumeration", "ASYNC_INFO",
                "Discovery of hidden or internal topics/channels"),
        MESSAGE_REPLAY("Message Replay Attack", "ASYNC_REPLAY",
                "Ability to replay captured messages"),
        SCHEMA_VALIDATION_BYPASS("Schema Validation Bypass", "ASYNC_VALIDATION",
                "Bypass of message schema validation"),
        POISONED_MESSAGE("Poisoned Message", "ASYNC_DOS",
                "Message causing consumer crashes or resource exhaustion"),
        SENSITIVE_DATA_EXPOSURE("Sensitive Data Exposure", "ASYNC_LEAK",
                "Exposure of sensitive data in message payloads"),
        WEAK_AUTHENTICATION("Weak Authentication", "ASYNC_AUTH",
                "Use of weak or insecure authentication mechanisms"),
        MISSING_AUTHORIZATION("Missing Authorization", "ASYNC_AUTH",
                "Operations missing proper authorization checks"),
        MISSING_ENCRYPTION("Missing Encryption", "ASYNC_CRYPTO",
                "Use of unencrypted protocol (ws, mqtt, kafka, http)"),
        EXCESSIVE_PRIVILEGES("Excessive Privileges", "ASYNC_AUTH",
                "Over-permissioned access to channels or operations"),
        MESSAGE_TAMPERING("Message Tampering", "ASYNC_INTEGRITY",
                "Ability to modify messages in transit"),
        DENIAL_OF_SERVICE("Denial of Service", "ASYNC_DOS",
                "Ability to overwhelm or crash the messaging system");

        private final String displayName;
        private final String category;
        private final String shortDescription;

        AsyncVulnerabilityType(String displayName, String category, String shortDescription) {
            this.displayName = displayName;
            this.category = category;
            this.shortDescription = shortDescription;
        }

        public String getDisplayName() {
            return displayName;
        }

        public String getCategory() {
            return category;
        }

        public String getShortDescription() {
            return shortDescription;
        }
    }

    /**
     * Protocol-specific metadata for AsyncAPI vulnerabilities.
     */
    public static class ProtocolMetadata {
        private final String protocol;
        private final String protocolVersion;
        private final String brokerUrl;
        private final String channel;
        private final Map<String, Object> bindingDetails;
        private final Map<String, Object> connectionDetails;

        private ProtocolMetadata(Builder builder) {
            this.protocol = builder.protocol;
            this.protocolVersion = builder.protocolVersion;
            this.brokerUrl = builder.brokerUrl;
            this.channel = builder.channel;
            this.bindingDetails = Collections.unmodifiableMap(new HashMap<>(builder.bindingDetails));
            this.connectionDetails = Collections.unmodifiableMap(new HashMap<>(builder.connectionDetails));
        }

        public String getProtocol() {
            return protocol;
        }

        public String getProtocolVersion() {
            return protocolVersion;
        }

        public String getBrokerUrl() {
            return brokerUrl;
        }

        public String getChannel() {
            return channel;
        }

        public Map<String, Object> getBindingDetails() {
            return bindingDetails;
        }

        public Map<String, Object> getConnectionDetails() {
            return connectionDetails;
        }

        public static Builder builder() {
            return new Builder();
        }

        public static class Builder {
            private String protocol;
            private String protocolVersion;
            private String brokerUrl;
            private String channel;
            private Map<String, Object> bindingDetails = new HashMap<>();
            private Map<String, Object> connectionDetails = new HashMap<>();

            public Builder protocol(String protocol) {
                this.protocol = protocol;
                return this;
            }

            public Builder protocolVersion(String protocolVersion) {
                this.protocolVersion = protocolVersion;
                return this;
            }

            public Builder brokerUrl(String brokerUrl) {
                this.brokerUrl = brokerUrl;
                return this;
            }

            public Builder channel(String channel) {
                this.channel = channel;
                return this;
            }

            public Builder bindingDetail(String key, Object value) {
                this.bindingDetails.put(key, value);
                return this;
            }

            public Builder bindingDetails(Map<String, Object> details) {
                this.bindingDetails.putAll(details);
                return this;
            }

            public Builder connectionDetail(String key, Object value) {
                this.connectionDetails.put(key, value);
                return this;
            }

            public Builder connectionDetails(Map<String, Object> details) {
                this.connectionDetails.putAll(details);
                return this;
            }

            public ProtocolMetadata build() {
                return new ProtocolMetadata(this);
            }
        }

        @Override
        public String toString() {
            return String.format("ProtocolMetadata{protocol='%s', version='%s', broker='%s', channel='%s'}",
                    protocol, protocolVersion, brokerUrl, channel);
        }
    }

    private AsyncVulnerabilityReport(Builder builder) {
        this.id = UUID.randomUUID().toString();
        this.type = Objects.requireNonNull(builder.type, "type cannot be null");
        this.severity = Objects.requireNonNull(builder.severity, "severity cannot be null");
        this.operation = Objects.requireNonNull(builder.operation, "operation cannot be null");
        this.protocolMetadata = Objects.requireNonNull(builder.protocolMetadata, "protocolMetadata cannot be null");
        this.title = builder.title != null ? builder.title : type.getDisplayName();
        this.description = builder.description;
        this.reproductionSteps = builder.reproductionSteps;
        this.exploitMessage = builder.exploitMessage;
        this.responseMessage = builder.responseMessage;
        this.evidence = builder.evidence != null
                ? Collections.unmodifiableMap(new LinkedHashMap<>(builder.evidence))
                : Collections.emptyMap();
        this.recommendations = builder.recommendations != null
                ? Collections.unmodifiableList(new ArrayList<>(builder.recommendations))
                : Collections.emptyList();
        this.discoveredAt = builder.discoveredAt != null ? builder.discoveredAt : Instant.now();
    }

    public static Builder builder() {
        return new Builder();
    }

    public String getId() {
        return id;
    }

    public AsyncVulnerabilityType getType() {
        return type;
    }

    public Severity getSeverity() {
        return severity;
    }

    public AsyncOperationSpec getOperation() {
        return operation;
    }

    public ProtocolMetadata getProtocolMetadata() {
        return protocolMetadata;
    }

    public String getTitle() {
        return title;
    }

    public String getDescription() {
        return description;
    }

    public String getReproductionSteps() {
        return reproductionSteps;
    }

    public ProtocolMessage getExploitMessage() {
        return exploitMessage;
    }

    public ProtocolMessage getResponseMessage() {
        return responseMessage;
    }

    public Map<String, Object> getEvidence() {
        return evidence;
    }

    public List<String> getRecommendations() {
        return recommendations;
    }

    public Instant getDiscoveredAt() {
        return discoveredAt;
    }

    @Override
    public String toString() {
        return String.format("AsyncVulnerabilityReport{id='%s', type=%s, severity=%s, protocol=%s, channel=%s, operation=%s}",
                id, type, severity, protocolMetadata.getProtocol(),
                protocolMetadata.getChannel(), operation.getOperationType());
    }

    public static class Builder {
        private AsyncVulnerabilityType type;
        private Severity severity;
        private AsyncOperationSpec operation;
        private ProtocolMetadata protocolMetadata;
        private String title;
        private String description;
        private String reproductionSteps;
        private ProtocolMessage exploitMessage;
        private ProtocolMessage responseMessage;
        private Map<String, Object> evidence;
        private List<String> recommendations;
        private Instant discoveredAt;

        public Builder type(AsyncVulnerabilityType type) {
            this.type = type;
            return this;
        }

        public Builder severity(Severity severity) {
            this.severity = severity;
            return this;
        }

        public Builder operation(AsyncOperationSpec operation) {
            this.operation = operation;
            return this;
        }

        public Builder protocolMetadata(ProtocolMetadata protocolMetadata) {
            this.protocolMetadata = protocolMetadata;
            return this;
        }

        public Builder title(String title) {
            this.title = title;
            return this;
        }

        public Builder description(String description) {
            this.description = description;
            return this;
        }

        public Builder reproductionSteps(String reproductionSteps) {
            this.reproductionSteps = reproductionSteps;
            return this;
        }

        public Builder exploitMessage(ProtocolMessage exploitMessage) {
            this.exploitMessage = exploitMessage;
            return this;
        }

        public Builder responseMessage(ProtocolMessage responseMessage) {
            this.responseMessage = responseMessage;
            return this;
        }

        public Builder evidence(Map<String, Object> evidence) {
            this.evidence = evidence;
            return this;
        }

        public Builder addEvidence(String key, Object value) {
            if (this.evidence == null) {
                this.evidence = new LinkedHashMap<>();
            }
            this.evidence.put(key, value);
            return this;
        }

        public Builder recommendations(List<String> recommendations) {
            this.recommendations = recommendations;
            return this;
        }

        public Builder addRecommendation(String recommendation) {
            if (this.recommendations == null) {
                this.recommendations = new ArrayList<>();
            }
            this.recommendations.add(recommendation);
            return this;
        }

        public Builder discoveredAt(Instant discoveredAt) {
            this.discoveredAt = discoveredAt;
            return this;
        }

        public AsyncVulnerabilityReport build() {
            return new AsyncVulnerabilityReport(this);
        }
    }
}
