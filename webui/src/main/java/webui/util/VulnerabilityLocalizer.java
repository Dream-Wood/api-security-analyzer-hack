package webui.util;

import active.model.VulnerabilityReport;
import com.apisecurity.analyzer.core.i18n.MessageService;

import java.util.HashMap;
import java.util.Map;

/**
 * Утилита для локализации результатов сканирования (VulnerabilityReport).
 * Заменяет английские title, description, recommendations на переведенные версии.
 */
public class VulnerabilityLocalizer {

    private VulnerabilityLocalizer() {
        // Utility class
    }

    /**
     * Получить локализованный заголовок для типа уязвимости.
     * Возвращает локализованную строку если доступна, иначе оригинальный title.
     *
     * @param report отчет об уязвимости
     * @return локализованный заголовок
     */
    public static String getLocalizedTitle(VulnerabilityReport report) {
        String key = "vulnerability." + report.getType().name().toLowerCase() + ".title";

        // Пробуем получить локализованный заголовок из bundle vulnerabilities
        String localized = MessageService.getMessage("vulnerabilities", key);

        // Если локализация не найдена (вернулся ключ), используем оригинальный title
        if (localized.equals(key)) {
            return report.getTitle();
        }

        return localized;
    }

    /**
     * Получить локализованное описание для типа уязвимости.
     * Возвращает локализованную строку если доступна, иначе оригинальное description.
     *
     * @param report отчет об уязвимости
     * @return локализованное описание
     */
    public static String getLocalizedDescription(VulnerabilityReport report) {
        String key = "vulnerability." + report.getType().name().toLowerCase() + ".description";

        // Пробуем получить локализованное описание из bundle vulnerabilities
        String localized = MessageService.getMessage("vulnerabilities", key);

        // Если локализация не найдена, используем оригинальное description
        if (localized.equals(key)) {
            return report.getDescription();
        }

        return localized;
    }

    /**
     * Получить локализованные рекомендации для типа уязвимости.
     * Возвращает список с переведенными рекомендациями или пустой список.
     *
     * @param report отчет об уязвимости
     * @return список локализованных рекомендаций
     */
    public static java.util.List<String> getLocalizedRecommendations(VulnerabilityReport report) {
        java.util.List<String> localizedRecs = new java.util.ArrayList<>();

        String keyPrefix = "vulnerability." + report.getType().name().toLowerCase() + ".recommendation";

        // Пробуем загрузить до 10 рекомендаций
        for (int i = 1; i <= 10; i++) {
            String key = keyPrefix + i;
            String value = MessageService.getMessage("vulnerabilities", key);

            // Если ключ не найден, прекращаем
            if (value.equals(key)) {
                break;
            }

            localizedRecs.add(value);
        }

        return localizedRecs;
    }

    /**
     * Создать локализованную копию VulnerabilityReport.
     * Заменяет title, description на локализованные версии если доступны.
     *
     * @param original оригинальный отчет
     * @return Map с локализованными полями для JSON сериализации
     */
    public static Map<String, Object> toLocalizedMap(VulnerabilityReport original) {
        Map<String, Object> localized = new HashMap<>();

        // Копируем базовые поля
        localized.put("id", original.getId());
        localized.put("type", original.getType().name());
        localized.put("severity", original.getSeverity().name());

        // Локализованные поля
        localized.put("title", getLocalizedTitle(original));
        localized.put("description", getLocalizedDescription(original));

        // Recommendations - используем локализованные если есть, иначе оригинальные
        java.util.List<String> localizedRecs = getLocalizedRecommendations(original);
        if (!localizedRecs.isEmpty()) {
            localized.put("recommendations", localizedRecs);
        } else {
            localized.put("recommendations", original.getRecommendations());
        }

        // Копируем остальные поля как есть
        localized.put("endpoint", original.getEndpoint());
        localized.put("reproductionSteps", original.getReproductionSteps());
        localized.put("evidence", original.getEvidence());
        localized.put("discoveredAt", original.getDiscoveredAt());

        return localized;
    }
}
